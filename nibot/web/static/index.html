<!DOCTYPE html>
<html lang="en">
<head>
<meta charset="utf-8">
<meta name="viewport" content="width=device-width, initial-scale=1">
<title>NiBot Dashboard</title>
<style>
*{box-sizing:border-box;margin:0;padding:0}
body{font-family:-apple-system,BlinkMacSystemFont,'Segoe UI',Roboto,sans-serif;background:#f5f5f5;color:#333;padding:20px}
.container{max-width:1200px;margin:0 auto}
h1{font-size:24px;margin-bottom:20px;color:#1a1a1a}
.grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(300px,1fr));gap:16px;margin-bottom:24px}
.card{background:#fff;border-radius:8px;padding:20px;box-shadow:0 1px 3px rgba(0,0,0,.1)}
.card h2{font-size:16px;color:#666;margin-bottom:12px;text-transform:uppercase;letter-spacing:1px;font-weight:600}
.stat{font-size:32px;font-weight:700;color:#1a1a1a}
.stat-label{font-size:13px;color:#999;margin-top:4px}
.badge{display:inline-block;padding:2px 8px;border-radius:12px;font-size:12px;font-weight:600}
.badge-ok{background:#e6f4ea;color:#1e7e34}
.badge-warn{background:#fff3cd;color:#856404}
.badge-error{background:#f8d7da;color:#721c24}
.badge-exec{background:#e8eaf6;color:#303f9f}
table{width:100%;border-collapse:collapse;margin-top:12px}
th,td{text-align:left;padding:8px 12px;border-bottom:1px solid #eee;font-size:14px}
th{color:#666;font-weight:600;font-size:12px;text-transform:uppercase}
tr.clickable{cursor:pointer}
tr.clickable:hover{background:#f8f9fa}
.btn{padding:6px 16px;border:none;border-radius:4px;cursor:pointer;font-size:13px;font-weight:600}
.btn-sm{padding:3px 10px;font-size:12px}
.btn-primary{background:#0066cc;color:#fff}
.btn-danger{background:#dc3545;color:#fff}
.btn-secondary{background:#6c757d;color:#fff}
.btn:hover{opacity:.85}
.btn:disabled{opacity:.5;cursor:not-allowed}
nav{display:flex;gap:12px;margin-bottom:24px;flex-wrap:wrap}
nav a{padding:8px 16px;background:#fff;border-radius:6px;text-decoration:none;color:#333;font-weight:500;box-shadow:0 1px 2px rgba(0,0,0,.08)}
nav a.active{background:#0066cc;color:#fff}
.loading{color:#999;font-style:italic}
.messages-panel{margin-top:8px;padding:12px;background:#f8f9fa;border-radius:6px;max-height:400px;overflow-y:auto}
.msg{padding:8px;margin-bottom:6px;border-radius:4px;font-size:13px;line-height:1.5}
.msg-user{background:#e3f2fd;border-left:3px solid #1976d2}
.msg-assistant{background:#f3e5f5;border-left:3px solid #7b1fa2}
.msg-tool,.msg-system{background:#e8f5e9;border-left:3px solid #388e3c}
.msg-role{font-weight:600;font-size:11px;text-transform:uppercase;color:#666;margin-bottom:2px}
.msg-content{word-break:break-word}
.msg-content pre{background:#f6f8fa;padding:12px;border-radius:6px;overflow-x:auto;margin:8px 0}
.msg-content code{font-family:'SF Mono',Monaco,'Cascadia Code',monospace;font-size:13px}
.msg-content :not(pre)>code{background:#f0f0f0;padding:2px 6px;border-radius:3px}
.msg-content p{margin:4px 0}
.msg-content ul,.msg-content ol{padding-left:20px;margin:4px 0}
.msg-content table{border-collapse:collapse;margin:8px 0}
.msg-content th,.msg-content td{border:1px solid #ddd;padding:6px 10px;font-size:13px}
.msg-content blockquote{border-left:3px solid #ddd;padding-left:12px;color:#666;margin:4px 0}
.config-grid{display:grid;grid-template-columns:repeat(auto-fit,minmax(200px,1fr));gap:12px;margin-top:12px}
.config-item{padding:12px;background:#f8f9fa;border-radius:6px}
.config-item .key{font-size:12px;color:#666;font-weight:600;text-transform:uppercase}
.config-item .value{font-size:16px;font-weight:600;margin-top:4px}
.toolbar{display:flex;gap:8px;margin-bottom:12px;align-items:center}
.chat-layout{display:flex;gap:16px;height:calc(100vh - 140px)}
.chat-sidebar{width:240px;flex-shrink:0;overflow-y:auto}
.chat-main{flex:1;display:flex;flex-direction:column}
.chat-scroll{flex:1;overflow-y:auto;padding:12px}
.chat-input-bar{border-top:1px solid #eee;padding:12px;display:flex;gap:8px}
.chat-input-bar input{flex:1;padding:8px 12px;border:1px solid #ddd;border-radius:6px;font-size:14px;outline:none}
.chat-input-bar input:focus{border-color:#0066cc}
.chat-session-item{padding:8px 10px;cursor:pointer;border-radius:4px;margin-bottom:4px;font-size:13px}
.chat-session-item:hover{background:#f0f0f0}
.chat-session-item.active{background:#e3f2fd}
.chat-progress{padding:8px 16px;color:#666;font-size:13px}
.progress-dot{display:inline-block;width:8px;height:8px;border-radius:50%;background:#4a9eff;animation:pulse 1s infinite;margin-right:6px;vertical-align:middle}
@keyframes pulse{0%,100%{opacity:1}50%{opacity:.3}}
@media(max-width:768px){.chat-sidebar{display:none}}
</style>
<link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/highlight.js@11/styles/github.min.css">
<script src="https://cdn.jsdelivr.net/npm/marked@15/marked.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/highlight.js@11/highlight.min.js"></script>
<script src="https://cdn.jsdelivr.net/npm/alpinejs@3/dist/cdn.min.js" defer></script>
</head>
<body>
<div class="container" x-data="dashboard()" x-init="init()">
  <!-- Token prompt -->
  <div x-show="showTokenPrompt" style="position:fixed;inset:0;background:rgba(0,0,0,.4);display:flex;align-items:center;justify-content:center;z-index:100">
    <div class="card" style="width:360px;text-align:center">
      <h2 style="margin-bottom:16px">Authentication Required</h2>
      <input type="password" x-model="authToken" @keydown.enter="saveToken()" placeholder="Enter auth token"
             style="width:100%;padding:10px;border:1px solid #ddd;border-radius:6px;font-size:14px;margin-bottom:12px">
      <button class="btn btn-primary" style="width:100%" @click="saveToken()">Login</button>
    </div>
  </div>

  <h1 style="display:flex;align-items:center;gap:12px">NiBot Dashboard
    <button x-show="authToken && !showTokenPrompt" class="btn btn-sm btn-secondary" @click="logout()" style="font-size:11px">Logout</button>
  </h1>

  <nav>
    <a href="#" :class="{'active': tab==='chat'}" @click.prevent="tab='chat';loadChatSessions()">Chat</a>
    <a href="#" :class="{'active': tab==='overview'}" @click.prevent="tab='overview'">Overview</a>
    <a href="#" :class="{'active': tab==='sessions'}" @click.prevent="tab='sessions';loadSessions()">Sessions</a>
    <a href="#" :class="{'active': tab==='skills'}" @click.prevent="tab='skills';loadSkills()">Skills</a>
    <a href="#" :class="{'active': tab==='tasks'}" @click.prevent="tab='tasks';loadTasks()">Tasks</a>
    <a href="#" :class="{'active': tab==='config'}" @click.prevent="tab='config';loadConfig()">Config</a>
  </nav>

  <!-- Chat -->
  <div x-show="tab==='chat'" class="chat-layout">
    <div class="card chat-sidebar">
      <div class="toolbar">
        <h2 style="margin-bottom:0">Chats</h2>
        <button class="btn btn-sm btn-primary" @click="newChat()">+ New</button>
      </div>
      <div style="margin-top:8px">
        <template x-for="s in chatSessions" :key="s.key">
          <div class="chat-session-item"
               :class="{'active': currentChatId===s.key.replace('web:','')}"
               @click="switchChat(s.key.replace('web:',''))">
            <div style="font-weight:600;white-space:nowrap;overflow:hidden;text-overflow:ellipsis"
                 x-text="s.last_user_msg||s.key.replace('web:','')"></div>
            <div style="font-size:11px;color:#999;margin-top:2px" x-text="s.messages+' msgs'"></div>
          </div>
        </template>
        <p x-show="chatSessions.length===0" class="loading" style="padding:8px">No conversations yet</p>
      </div>
    </div>
    <div class="card chat-main">
      <div class="chat-scroll" x-ref="chatScroll">
        <template x-for="(m,i) in chatMessages" :key="i">
          <div class="msg" :class="'msg-'+m.role">
            <div class="msg-role" x-text="m.role"></div>
            <div class="msg-content" x-html="renderMd(m.content)"></div>
          </div>
        </template>
        <div x-show="chatStreamContent" class="msg msg-assistant">
          <div class="msg-role">assistant</div>
          <div class="msg-content" x-html="renderMd(chatStreamContent)"></div>
        </div>
        <div x-show="chatLoading && !chatStreamContent" class="chat-progress">
          <span class="progress-dot"></span>
          <span x-text="chatProgress || 'Thinking...'"></span>
        </div>
        <p x-show="!chatLoading && chatMessages.length===0 && !chatStreamContent" class="loading" style="padding:20px;text-align:center">
          Send a message to start chatting
        </p>
      </div>
      <div class="chat-input-bar">
        <input type="text" x-model="chatInput" @keydown.enter="sendChat()"
               placeholder="Type a message..." :disabled="chatLoading">
        <button class="btn btn-primary" @click="sendChat()" :disabled="chatLoading || !chatInput.trim()">Send</button>
      </div>
    </div>
  </div>

  <!-- Overview -->
  <div x-show="tab==='overview'">
    <div class="grid">
      <div class="card">
        <h2>Status</h2>
        <div class="stat">
          <span class="badge" :class="health.status==='ok'?'badge-ok':'badge-warn'" x-text="health.status||'loading'"></span>
        </div>
        <div class="stat-label" x-text="'Model: '+(health.model||'...')"></div>
      </div>
      <div class="card">
        <h2>Sessions</h2>
        <div class="stat" x-text="health.active_sessions||0"></div>
        <div class="stat-label">Active</div>
      </div>
      <div class="card">
        <h2>Tasks</h2>
        <div class="stat" x-text="health.active_tasks||0"></div>
        <div class="stat-label">Running</div>
      </div>
      <div class="card">
        <h2>Channels</h2>
        <div class="stat" x-text="(health.channels||[]).length"></div>
        <div class="stat-label" x-text="(health.channels||[]).join(', ')||'none'"></div>
      </div>
    </div>
    <div class="card">
      <h2>Analytics</h2>
      <div class="grid" style="margin-top:12px">
        <div><span class="stat-label">Sessions analyzed:</span> <strong x-text="analytics.session_count||0"></strong></div>
        <div><span class="stat-label">Error rate:</span> <strong x-text="((analytics.overall_error_rate||0)*100).toFixed(1)+'%'"></strong></div>
        <div><span class="stat-label">Avg turns:</span> <strong x-text="(analytics.avg_turns_per_session||0).toFixed(1)"></strong></div>
      </div>
    </div>
  </div>

  <!-- Sessions -->
  <div x-show="tab==='sessions'">
    <div class="card">
      <h2>Recent Sessions</h2>
      <table>
        <tr><th>Key</th><th>Messages</th><th>Tools</th><th>Errors</th><th>Updated</th></tr>
        <template x-for="s in sessions" :key="s.key">
          <tr>
            <td>
              <a href="#" @click.prevent="toggleMessages(s.key)" x-text="s.key" style="color:#0066cc;text-decoration:none"></a>
              <div x-show="expandedSession===s.key" class="messages-panel">
                <template x-for="m in sessionMessages" :key="m.timestamp">
                  <div class="msg" :class="'msg-'+m.role">
                    <div class="msg-role" x-text="m.role"></div>
                    <div class="msg-content" x-html="renderMd(m.content)"></div>
                  </div>
                </template>
                <p x-show="sessionMessages.length===0" class="loading">No messages</p>
              </div>
            </td>
            <td x-text="s.messages"></td>
            <td x-text="s.tool_calls"></td>
            <td x-text="s.errors"></td>
            <td x-text="s.updated_at"></td>
          </tr>
        </template>
      </table>
    </div>
  </div>

  <!-- Skills -->
  <div x-show="tab==='skills'">
    <div class="card">
      <div class="toolbar">
        <h2 style="margin-bottom:0">Skills</h2>
        <button class="btn btn-sm btn-secondary" @click="reloadSkills()">Reload All</button>
      </div>
      <table>
        <tr><th>Name</th><th>Description</th><th>Version</th><th>Type</th><th>Always</th><th>Actions</th></tr>
        <template x-for="s in skills" :key="s.name">
          <tr>
            <td x-text="s.name"></td>
            <td x-text="s.description"></td>
            <td x-text="'v'+s.version"></td>
            <td><span class="badge" :class="s.executable?'badge-exec':'badge-ok'" x-text="s.executable?'Executable':'Guidance'"></span></td>
            <td x-text="s.always?'Yes':'No'"></td>
            <td><button class="btn btn-sm btn-danger" @click="deleteSkill(s.name)">Delete</button></td>
          </tr>
        </template>
      </table>
      <p x-show="skills.length===0" class="loading">No skills loaded</p>
    </div>
  </div>

  <!-- Tasks -->
  <div x-show="tab==='tasks'">
    <div class="card">
      <h2>Recent Tasks</h2>
      <table>
        <tr><th>ID</th><th>Type</th><th>Label</th><th>Status</th><th>Created</th></tr>
        <template x-for="t in tasks" :key="t.task_id">
          <tr>
            <td x-text="t.task_id"></td>
            <td x-text="t.agent_type"></td>
            <td x-text="t.label"></td>
            <td><span class="badge" :class="t.status==='completed'?'badge-ok':t.status==='error'?'badge-error':'badge-warn'" x-text="t.status"></span></td>
            <td x-text="t.created_at"></td>
          </tr>
        </template>
      </table>
      <p x-show="tasks.length===0" class="loading">No tasks</p>
    </div>
  </div>

  <!-- Config -->
  <div x-show="tab==='config'">
    <div class="card">
      <h2>Agent Configuration</h2>
      <div class="config-grid">
        <div class="config-item">
          <div class="key">Model</div>
          <div class="value" x-text="config.agent?.model||'...'"></div>
        </div>
        <div class="config-item">
          <div class="key">Temperature</div>
          <div class="value" x-text="config.agent?.temperature||'...'"></div>
        </div>
        <div class="config-item">
          <div class="key">Max Tokens</div>
          <div class="value" x-text="config.agent?.max_tokens||'...'"></div>
        </div>
        <div class="config-item">
          <div class="key">Max Iterations</div>
          <div class="value" x-text="config.agent?.max_iterations||'...'"></div>
        </div>
        <div class="config-item">
          <div class="key">Sandbox</div>
          <div class="value" x-text="config.tools?.sandbox_enabled?'Enabled':'Disabled'"></div>
        </div>
        <div class="config-item">
          <div class="key">Exec Timeout</div>
          <div class="value" x-text="(config.tools?.exec_timeout||60)+'s'"></div>
        </div>
      </div>
    </div>
    <div class="card" style="margin-top:16px" x-show="config.agents && Object.keys(config.agents).length>0">
      <h2>Sub-Agent Types</h2>
      <table>
        <tr><th>Type</th><th>Model</th><th>Tools</th></tr>
        <template x-for="[name,cfg] in Object.entries(config.agents||{})" :key="name">
          <tr>
            <td x-text="name"></td>
            <td x-text="cfg.model||'(default)'"></td>
            <td x-text="(cfg.tools||[]).join(', ')"></td>
          </tr>
        </template>
      </table>
    </div>
  </div>
</div>

<script>
function dashboard(){return{
  tab:'chat',health:{},analytics:{},sessions:[],skills:[],tasks:[],config:{},
  expandedSession:'',sessionMessages:[],
  chatSessions:[],currentChatId:'',chatMessages:[],chatInput:'',chatLoading:false,chatStreamContent:'',chatProgress:'',
  authToken:'',showTokenPrompt:false,
  async init(){
    if(typeof marked!=='undefined'){
      marked.setOptions({breaks:true,gfm:true});
    }
    this.authToken=localStorage.getItem('nibot_token')||new URLSearchParams(location.search).get('token')||'';
    if(!this.authToken){this.showTokenPrompt=true;return}
    await this.loadHealth();
    await this.loadAnalytics();
    this.loadChatSessions();
    setInterval(()=>this.loadHealth(),10000);
  },
  renderMd(text){
    if(!text)return'';
    try{
      if(typeof marked!=='undefined'){
        const html=marked.parse(text);
        this.$nextTick(()=>{if(typeof hljs!=='undefined')document.querySelectorAll('.msg-content pre code:not(.hljs)').forEach(el=>hljs.highlightElement(el))});
        return html;
      }
    }catch(e){}
    return text.replace(/&/g,'&amp;').replace(/</g,'&lt;').replace(/>/g,'&gt;').replace(/\n/g,'<br>');
  },
  saveToken(){
    this.authToken=this.authToken.trim();
    if(!this.authToken)return;
    localStorage.setItem('nibot_token',this.authToken);
    this.showTokenPrompt=false;
    this.init();
  },
  logout(){localStorage.removeItem('nibot_token');this.authToken='';this.showTokenPrompt=true},
  async api(path,opts={}){
    try{
      opts.headers={...(opts.headers||{}),'Authorization':'Bearer '+this.authToken};
      const r=await fetch('/api/'+path,opts);
      if(r.status===401){this.showTokenPrompt=true;return{}}
      return await r.json();
    }catch(e){return{error:e.message||'Network error'}}
  },
  async loadHealth(){this.health=await this.api('health')},
  async loadAnalytics(){this.analytics=await this.api('analytics')},
  async loadSessions(){const d=await this.api('sessions');this.sessions=d.sessions||[];this.expandedSession='';this.sessionMessages=[]},
  async loadSkills(){const d=await this.api('skills');this.skills=d.skills||[]},
  async loadTasks(){const d=await this.api('tasks');this.tasks=d.tasks||[]},
  async loadConfig(){this.config=await this.api('config')},
  async toggleMessages(key){
    if(this.expandedSession===key){this.expandedSession='';this.sessionMessages=[];return}
    this.expandedSession=key;
    const d=await this.api('sessions/messages?key='+encodeURIComponent(key));
    this.sessionMessages=d.messages||[];
  },
  async deleteSkill(name){
    if(!confirm('Delete skill "'+name+'"?'))return;
    await this.api('skills',{method:'DELETE',headers:{'Content-Type':'application/json'},body:JSON.stringify({name})});
    await this.loadSkills();
  },
  async reloadSkills(){
    await this.api('skills/reload',{method:'POST'});
    await this.loadSkills();
  },
  // ---- Chat ----
  async loadChatSessions(){
    const d=await this.api('chat/sessions');
    this.chatSessions=d.sessions||[];
  },
  newChat(){
    this.currentChatId='';
    this.chatMessages=[];
    this.chatStreamContent='';
    this.chatProgress='';
    this.chatInput='';
  },
  async switchChat(id){
    this.currentChatId=id;
    this.chatStreamContent='';
    const d=await this.api('chat/history?chat_id='+encodeURIComponent(id));
    this.chatMessages=d.messages||[];
    this.$nextTick(()=>{const el=this.$refs.chatScroll;if(el)el.scrollTop=el.scrollHeight;});
  },
  async sendChat(){
    const msg=this.chatInput.trim();
    if(!msg||this.chatLoading)return;
    this.chatInput='';
    this.chatLoading=true;
    this.chatMessages.push({role:'user',content:msg,timestamp:new Date().toISOString()});
    this.$nextTick(()=>{const el=this.$refs.chatScroll;if(el)el.scrollTop=el.scrollHeight;});

    const res=await this.api('chat/send',{
      method:'POST',
      headers:{'Content-Type':'application/json'},
      body:JSON.stringify({content:msg,chat_id:this.currentChatId})
    });

    if(res.error){
      this.chatMessages.push({role:'assistant',content:'Error: '+res.error});
      this.chatLoading=false;
      return;
    }
    this.currentChatId=res.chat_id;
    this.chatStreamContent='';
    this.chatProgress='';

    const es=new EventSource('/api/chat/stream?id='+res.stream_id+'&token='+encodeURIComponent(this.authToken));
    es.onmessage=(e)=>{
      if(e.data==='[DONE]'){
        es.close();
        if(this.chatStreamContent){
          this.chatMessages.push({role:'assistant',content:this.chatStreamContent,timestamp:new Date().toISOString()});
        }
        this.chatStreamContent='';
        this.chatProgress='';
        this.chatLoading=false;
        this.loadChatSessions();
        this.$nextTick(()=>{const el=this.$refs.chatScroll;if(el)el.scrollTop=el.scrollHeight;});
        return;
      }
      try{
        const data=JSON.parse(e.data);
        if(data.type==='progress'){
          if(data.event==='thinking'){
            this.chatProgress='Thinking ('+data.iteration+'/'+data.max_iterations+')...';
            this.chatStreamContent='';
          }else if(data.event==='tool_start'){
            this.chatProgress='Calling '+data.tool_name+'...';
          }else if(data.event==='tool_done'){
            this.chatProgress=data.tool_name+' done ('+data.elapsed+'s)';
          }
        }else if(data.type==='chunk'){
          this.chatStreamContent=data.content||'';
        }else if(data.type==='done'){
          this.chatStreamContent=data.content||'';
        }
        this.$nextTick(()=>{const el=this.$refs.chatScroll;if(el)el.scrollTop=el.scrollHeight;});
      }catch(err){}
    };
    es.onerror=()=>{
      es.close();
      if(this.chatStreamContent){
        this.chatMessages.push({role:'assistant',content:this.chatStreamContent,timestamp:new Date().toISOString()});
      }else if(this.chatLoading){
        this.chatMessages.push({role:'assistant',content:'(connection lost)'});
      }
      this.chatStreamContent='';
      this.chatProgress='';
      this.chatLoading=false;
    };
  },
}}
</script>
</body>
</html>
